<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Flappy Game</title>
  <style>
    canvas { border: 1px solid black; display: block; margin: 20px auto; }
    #startBtn { display: block; margin: 10px auto; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  <button id="startBtn">ğŸ® Start Voice Game</button>

  <!-- Recorder.js -->
  <script src="https://cdn.jsdelivr.net/gh/mattdiamond/Recorderjs@master/dist/recorder.js"></script>
  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let player = { x: 50, y: 150, vy: 0, size: 20 };
    let gravity = 0.1, jump = -3, fall = 3, pipes = [], score = 0;
    let moving = false, gameOver = false, frame = 0;

    function draw() {
      ctx.fillStyle = "#eee";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "blue";
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#000";
      ctx.font = "18px Arial";
      ctx.fillText(`Score: ${score}`, 10, 20);
      if (gameOver) ctx.fillText("Game Over! Say 'go' to restart", 260, 200);
    }

    function update() {
      if (moving) {
        player.vy += gravity;
        player.y += player.vy;
      }
      if (player.y > canvas.height || player.y < 0) {
        gameOver = true;
        moving = false;
      }
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    loop();

    socket.on("command", cmd => {
      console.log("ğŸ® Command:", cmd);
      if (cmd === "up") player.vy = jump;
      else if (cmd === "down") player.vy += fall;
      else if (cmd === "stop") moving = false;
      else if (cmd === "go") {
        if (gameOver) {
          player.y = 150; player.vy = 0; score = 0; gameOver = false;
        }
        moving = true;
      }
    });

    document.getElementById("startBtn").onclick = () => {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const input = audioContext.createMediaStreamSource(stream);
        const recorder = new Recorder(input, { numChannels: 1 });

        setInterval(() => {
          recorder.clear();
          recorder.record();
          setTimeout(() => {
            recorder.stop();
            recorder.exportWAV(blob => {
              socket.emit("audio_blob", blob);
              console.log("ğŸ“¡ Sent blob");
            });
          }, 1000);
        }, 1200);
      });

      document.getElementById("startBtn").disabled = true;
      document.getElementById("startBtn").innerText = "ğŸ™ï¸ Voice Active...";
    };
  </script>
</body>
</html>
